<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Capi: Shop for Lessons!</title>
        <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
        <script src="server.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
        <style>
            #lessonBlock, #cartBlock {
                background-color: #f5f5f5;
                border: 2px solid #e4e4e4;
                border-radius: 15px;
                padding: 15px;
                float: left;
            }
            #lessonBlock{
                height: 250px;
                width: 400px; 
                margin: 15px;
            }
            #cartBlock {
                height: 200px;
                width: 320px;
                margin: 5px;
            }
            #checkout {
                width: 50%;
                float: left;
            }
            #checkoutBlock {
                background-color: #f5f5f5;
                border: 2px solid #e4e4e4;
                border-radius: 15px;
                width: 95%;
                padding: 15px;
                float: left;
            }
            #lessonContent, #cartContent {
                margin-top: 20px;
                margin-left: 25px;
                float: left;
            }
            #lessonContent {
                margin-top: 20px;
            }
            #cartContent {
                margin-top: 35px;
            }
            #lessonImage{
                margin-top: 30px;
                margin-left: 10px;
                float: left;
            }
            #sortArea{
                padding: 15px;
                margin: auto;
                margin-top: 30px;
                width: 80%;
                color: white;
            }
            #sortBG{
                width: 24%;
                background-color: #464c83;
                height: 100vh;
                float: left;
                border-right: 1px solid #9a9a9a;
            }
            #lessonArea{
                width: 62%;
                background-color: white;
                height: 80vh;
                float: left;
                justify-content: center;
                overflow: auto;
            }
            #cartArea{
                width: 49%;
                margin:5px;
                background-color: white;
                height: 74vh;
                float: left;
                justify-content: center;
                overflow: auto;
            }
            #searchArea{
                padding: 10px;
                border-radius: 5px;
                border-style: solid;
                border-color: #ffffff;
                width: 200px;
            }
            h1, h2, p, label, strong, button{
                font-family: verdana;
            }
            hr{
                margin-bottom: 0;
            }
            p{
                font-size: 15px;
            }
            span{
                font-family: verdana;
                font-size: 12px;
                margin-left: 5px;
                color: #454545;
            }
            header{
                width: 100%;
                text-align: center;
                background-color: #f6f7ee;
                font-size: 20px;
            }
            button{
                padding: 10px;
                border-radius: 5px;
                border: 2px solid #8a8da8;
                background-color: #ffffff;
                color: black;
            }
            button:disabled {
                border: 2px solid #9a9a9a;
                background-color: #cfcfcf;
                color: #454545;
            }
            main{
                width: 100%;
                height: 100vh;
                min-height: 100vh;
            }
            html, body{
                padding: 0;
                margin: 0;
                overflow: hidden;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <header>
                <br>
                <h1 v-text="sitename"></h1>
                    <button v-on:click="showShopCart()" id="shopCartButton" hidden="true">
                        <i class="fa-solid fa-cart-plus"></i>
                        {{cartItemCount}} Shopping Cart
                    </button>
                <hr>
            </header>
            <main>
                <div style="height: 100vh;" v-if="showLesson">
                    <div id="sortBG">
                        <div id="sortArea">
                            <input id="searchArea" type="text" placeholder="Search.." v-on:keyup="searchLessons()">
                            <br><br>
                            <p>Sort by:</p><br>
                            <input type="radio" id="subject" name="sortCategory" value="subject" v-on:click="sortLessons()">
                            <label for="subject">Subject</label><br>
                            <input type="radio" id="location" name="sortCategory" value="location" v-on:click="sortLessons()">
                            <label for="location">Location</label><br>
                            <input type="radio" id="price" name="sortCategory" value="price" v-on:click="sortLessons()">
                            <label for="price">Price</label><br>
                            <input type="radio" id="availability" name="sortCategory" value="availability" v-on:click="sortLessons()" checked>
                            <label for="availability">Availability</label>
                            <br><br>
                            
                            <p>Order:</p><br>
                            <input type="radio" id="ascending" name="sortOrder" value="ascending" v-on:click="sortLessons()" checked>
                            <label for="ascending">Ascending</label><br>
                            <input type="radio" id="descending" name="sortOrder" value="descending" v-on:click="sortLessons()">
                            <label for="descending">Descending</label>
                        </div>
                    </div>
                
                    <div id="lessonArea">
                        <div id="lessonBlock" v-for="lesson in lessons">
                            <div id="lessonImage">
                                <img style="width: 190px" v-bind:src="lesson.image">
                            </div>
                            <div id="lessonContent">
                                <strong v-text="lesson.subject"></strong>
                                <p v-html="lesson.location"></p>
                                <p>Price: {{lesson.price}} </p>
                                <p>Available Stock: {{lesson.availability - cartCount (lesson)}}</p>
                                
                                <button v-on:click="addToCart(lesson)" v-if="canAddToCart(lesson)">
                                    Add to cart
                                </button> 
                                <button disabled ="disabled" v-else>
                                    Out of stock
                                </button>
                                
                                <span v-if="lesson.availability === cartCount(lesson)">
                                    All out !!
                                </span>
                                <span v-else-if="lesson.availability - cartCount(lesson) < 5">
                                    Only {{lesson.availability - cartCount (lesson)}} left!
                                </span>
                                <span v-else>
                                    Buy now !!
                                </span>
                                <div style="margin-top: 13px;">
                                    <span style="font-size: 20px;" v-for="n in lesson.rating"><i class="fas fa-star"></i></span>
                                    <span style="font-size: 20px;" v-for="n in 5 - lesson.rating"><i class="far fa-star"></i></span>
                                </div>
                            </div>
                        </div><br><br>
                    </div>
                </div>
                <div v-else-if="showCart">
                    <div style="height: 100vh">
                        <div id="cartArea">
                            <p>Shopping Cart</p>
                            <div id="cartBlock" v-for="lesson in cart">
                                <div id="lessonImage">
                                    <img style="width: 150px" v-bind:src="lesson.image">
                                </div>
                                <div id="cartContent">
                                    <strong v-text="lesson.subject"></strong>
                                    <p style="font-size: 12px" v-html="lesson.location"></p>
                                    <p style="font-size: 12px">Price: {{lesson.price}} </p>
                                    <button v-on:click="removeCart(lesson)">
                                        Remove
                                    </button>                           
                                </div>
                            </div><br><br>
                        </div>
                        <div id="checkout">
                            <p>Checkout Details</p>
                            <div id="checkoutBlock">
                                <p>
                                    First Name: 
                                    <input v-model="order.firstName"/>
                                </p>
                                <p>
                                    Last Name: 
                                    <input v-model="order.lastName"/>
                                </p>
                                <p>
                                    Phone Number: 
                                    <input v-model="order.phoneNum"/>
                                </p>
                                <p>
                                    Address: 
                                    <input v-model="order.address"/>
                                </p>
                                <p>
                                    City: 
                                    <input v-model="order.city"/>
                                </p>

                                <button v-on:click="submitForm" :disabled="!enableOrder()">
                                    Place order
                                </button>
                            </div>
                        </div>
                    </div>
                    
                </div>
                <div v-else>
                    <h2>Order Information</h2>
                    <p>First Name: {{order.firstName}}</p>
                    <p>Last Name: {{order.lastName}}</p>
                    <p>Address: {{order.address}}</p>
                    <p>City: {{order.city}}</p>
                   
                </div>
            </main>
        </div>

        <script type="text/javascript">
            let webstore = new Vue({
                el:'#app',
                data: {
                    sitename: 'Capi',
                    lessons: [],
                    cart:[],
                    showLesson:true,
                    showCart: false,
                    order:{
                        firstName:'',
                        lastName:'',
                        phoneNum: '',
                        address:'',
                        city:''
                    },
                    states: {
                        AL: 'Alabama',
                        AR: 'Arizona',
                        CA: 'California',
                        NV: 'Nevada'
                    }
                },
                methods:{
                    addToCart(lesson){
                        const shopCartButton = document.getElementById('shopCartButton');
                        shopCartButton.hidden = false;
                        this.cart.push(lesson);
                    },
                    removeCart(lesson){
                        let index = this.cart.indexOf(lesson);
                        if (index > -1) {
                            this.cart.splice(index, 1);
                        }
                    },
                    showShopCart(){
                        this.showLesson = this.showLesson ? false:true;
                        this.showCart = this.showCart ? false:true;
                    },
                    showOrder(){
                        this.showCart = this.showCart ? false:true;
                        const shopCartButton = document.getElementById('shopCartButton');
                        shopCartButton.hidden = true;
                    },
                    enableOrder() {
                        const regexName = /^[A-Za-z]+$/;
                        const regexNum = /^\d+$/;
                        return regexName.test(this.order.firstName) && regexNum.test(this.order.phoneNum);
                    },
                    submitForm(){
                        alert("order submitted !!");
                        this.showCart = this.showCart ? false:true;

                        let orderedLessons = webstore.cart.map(item => item.subject);
                        let orderedIDs = webstore.cart.map(item => item._id);

                        let itemCount = {};
                        for (let item of orderedLessons) {
                            itemCount[item] = (itemCount[item] || 0) + 1;
                        }

                        let lessonCount = [];
                        let lessonIds = [];

                        for (const item in itemCount) {
                            lessonCount.push(`${item} x ${itemCount[item]}`);
                            lessonIds.push(`${item} x ${itemCount[item]}`);
                        }

                        const newOrder = {name: this.order.firstName, phoneNum: this.order.phoneNum,
                            lessonIDs: lessonCount, numOfSpaces: orderedLessons.length};

                        fetch('https://cst3144-backend-1-ckst.onrender.com/collection/Orders', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(newOrder),
                        })
                        .then(response => response.json())
                        .then(responseJSON => {
                            document.getElementById('response').innerText = JSON.stringify(responseJSON);
                        })
                        .catch((error) => {
                            document.getElementById('error').innerText = error;
                        });

                        for (let i = 0; i < orderedIDs.length; i++) {
                            const lessonId = orderedIDs[i];
                            fetch(`https://cst3144-backend-1-ckst.onrender.com/collection/Lessons/${lessonId}/`)
                                .then(response => response.json())
                                .then(lessonData => {
                                const currentAvailability = lessonData.availability;
                                const newAvailability = currentAvailability - 1;

                                fetch(`https://cst3144-backend-1-ckst.onrender.com/collection/Lessons/${lessonId}/`, {
                                    method: 'PUT',
                                    headers: {
                                    'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ availability: newAvailability }),
                                })
                                .then(response => response.json())
                                .then(responseJSON => {
                                    document.getElementById('response').innerText = JSON.stringify(responseJSON);
                                })
                                .catch((error) => {
                                    document.getElementById('error').innerText = error;
                                });
                                })
                            .catch((error) => {
                            document.getElementById('error').innerText = error;
                            });
                        }
                    },
                    searchLessons(){
                        let userSearch = document.querySelector("#searchArea").value.toLowerCase();

                        fetch(`https://cst3144-backend-1-ckst.onrender.com/search/Lessons?search=${userSearch}`, {
                            method: 'GET'
                        })
                        .then(response => response.json())
                        .then(responseJSON => {
                            this.lessons = responseJSON;
                        })
                        .catch((error) => {
                            document.getElementById('error').innerText = error;
                        });
                    },
                    canAddToCart(lesson){
                        return lesson.availability>this.cartCount(lesson);
                    },
                    cartCount(lesson){
                        let count = 0;
                        for (let i = 0; i < this.cart.length; i++){
                            if (this.cart[i] === lesson){
                                count++;
                            }
                        }
                        return count;
                    },
                    sortLessons() {
                        let category = document.querySelector('input[name="sortCategory"]:checked').value;
                        let sortOrder = document.querySelector('input[name="sortOrder"]:checked').value;

                        if (sortOrder === "ascending"){
                            this.lessons.sort((a, b) => {
                                let valA = a[category];
                                let valB = b[category];

                                if (typeof valA === 'string' && typeof valB === 'string') {
                                    valA = valA.toLowerCase();
                                    valB = valB.toLowerCase();
                                }

                                if (valA > valB) return 1;
                                if (valB > valA) return -1;
                                return 0;
                            });
                        }
                        else{
                            this.lessons.sort((a, b) => {
                                let valA = b[category];
                                let valB = a[category];

                                if (typeof valA === 'string' && typeof valB === 'string') {
                                    valA = valA.toLowerCase();
                                    valB = valB.toLowerCase();
                                }

                                if (valA > valB) return 1;
                                if (valB > valA) return -1;
                                return 0;
                            });
                        }                        
                    }
                },
                computed:{
                    cartItemCount: function() { 
                        return this.cart.length || "";
                    },
                    canAddToCart: function(){
                        return this.lesson.availability > this.cartItemCount;
                    },
                    itemsLeft() {
                        return this.lesson.availability - this.cartItemCount;
                    },
                    cartNotEmpty() {
                        return cartCount != 0;
                    }
                }
            });
            fetch('https://cst3144-backend-1-ckst.onrender.com/collection/Lessons', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                webstore.lessons = data.map(item => {
                    return {
                        _id: item._id,
                        id: item.id,
                        subject: item.subject,
                        location: item.location,
                        price: item.price,
                        image: item.image,
                        availability: item.availability,
                        rating: item.rating
                    };
                });
                webstore.lessons = webstore.lessons;
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            }); 
        </script>
    </body>
</html>
<html>
    <head>
        <title>huehue</title>
        <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
        <script src="server.js"></script>
        <style>
            #lessonBlock, #cartBlock {
                background-color: rgb(230, 213, 167);
                border-radius: 15px;
                border-color: rgb(183, 150, 104);
                border-style: solid;
                border-width: 5px;
                padding: 15px;
                overflow:auto;
                float: left;
            }
            #lessonBlock {
                margin-left: 50px;  
                margin: 15px;
            }
            #cartBlock {
                margin: 5px;
            }
            #checkout {
                background-color: rgb(230, 213, 167);
                border-radius: 15px;
                border-color: rgb(183, 150, 104);
                border-style: solid;
                border-width: 5px;
                width: 95%;
                height: 50%;
                padding: 15px;
                margin: auto;
            }
            #lessonContent {
                margin-left: 15px;
                float: left;
            }
            #lessonImage{
                margin-left: auto;
                float: left;
            }
            #sortArea{
                width: 20%;
                background-color: rgb(235, 216, 189);
                height: 100%;
                overflow: auto;
                float: left;
            }
            #lessonArea{
                width: 75%;
                background-color: white;
                height: 100%;
                float: left;
            }
            h1, h2, p, label{
                font-family: calibri;
            }
            header{
                width: 100%;
                text-align: center;
                background-color: rgb(183, 150, 104);
                font-size: 30px;
            }
            main{
                width: 100%;
                height: 100%;
                min-height: 100%;
            }
            html, body{
                padding: 0;
                margin: 0;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <header>
                <h1 v-text="sitename"></h1>
                <div id="item-list"></div>
                <button v-on:click="showShopCart()" id="shopCartButton" hidden="true">
                    {{cartItemCount}}
                    <i class="fa-solid fa-cart-plus"></i>shopping cart
                </button>
            </header>
            <main>
                <div v-if="showLesson">
                    <div id="sortArea">
                        <input id="searchArea" type="text" placeholder="search.." v-on:keyup="searchLessons()">

                        <p>sort by</p><br>
                        <input type="radio" id="subject" name="sortCategory" value="subject" v-on:click="sortLessons()" checked>
                        <label for="subject">subject</label><br>
                        <input type="radio" id="location" name="sortCategory" value="location" v-on:click="sortLessons()">
                        <label for="location">location</label><br>
                        <input type="radio" id="price" name="sortCategory" value="price" v-on:click="sortLessons()">
                        <label for="price">price</label><br>
                        <input type="radio" id="availability" name="sortCategory" value="availability" v-on:click="sortLessons()">
                        <label for="availability">availability</label>
                        <br><br>
                        
                        <p>order:</p><br>
                        <input type="radio" id="ascending" name="sortOrder" value="ascending" v-on:click="sortLessons()" checked>
                        <label for="ascending">ascending</label><br>
                        <input type="radio" id="descending" name="sortOrder" value="descending" v-on:click="sortLessons()">
                        <label for="descending">descending</label>
                    </div>
                    <div id="lessonArea">
                        <div id="lessonBlock" v-for="lesson in lessons">
                            <div id="lessonImage">
                                <img style="width: 205px" v-bind:src="lesson.image">
                            </div>
                            <div id="lessonContent">
                                <h2 v-text="lesson.subject"></h2>
                                <p v-html="lesson.location"></p>
                                <p>price: {{lesson.price}} </p>
                                <p>available stock: {{lesson.availability - cartCount (lesson)}}</p>
                                
                                <button v-on:click="addToCart(lesson)" v-if="canAddToCart(lesson)">
                                    add to cart
                                </button> 
                                <button disabled ="disabled" v-else>
                                    out of stock
                                </button>
                                
                                <span v-if="lesson.availability === cartCount(lesson)">
                                    all out !!
                                </span>
                                <span v-else-if="lesson.availability - cartCount(lesson) < 5">
                                    only {{lesson.availability - cartCount (lesson)}} left !!
                                </span>
                                <span v-else>
                                    buy now !!
                                </span>
                                
                                <div>
                                    <span v-for="n in lesson.rating">★</span>
                                    <span v-for="n in 5 - lesson.rating">☆</span>
                                </div>
                            </div>
                        </div><br><br>
                    </div>
                </div>
                <div v-else-if="showCart">
                    <h2>shopping cart</h2>
                    <div style="height: 100%">
                        <div style="height: 50%">
                            <div id="cartBlock" v-for="lesson in cart">
                                <div id="lessonImage">
                                    <img style="width: 205px" v-bind:src="lesson.image">
                                </div>
                                <div id="lessonContent">
                                    <h2 v-text="lesson.subject"></h2>
                                    <p v-html="lesson.location"></p>
                                    <p>price: {{lesson.price}} </p>
                                    <button v-on:click="removeCart(lesson)">
                                        remove
                                    </button>                           
                                </div>
                            </div><br><br>
                        </div>
                    
                        <div id="checkout">
                            <p>
                                <strong>first name: </strong>
                                <input v-model="order.firstName"/>
                            </p>
                            <p>
                                <strong>last name: </strong>
                                <input v-model="order.lastName"/>
                            </p>
                            <p>
                                <strong>phone number: </strong>
                                <input v-model="order.phoneNum"/>
                            </p>
                            <p>
                                <strong>address: </strong>
                                <input v-model="order.address"/>
                            </p>
                            <p>
                                <strong>city: </strong>
                                <input v-model="order.city"/>
                            </p>

                            <button v-on:click="submitForm" :disabled="!enableOrder()">
                                place order
                            </button>
                        </div><br><br>
                    </div>
                    
                </div>
                <div v-else>
                    <h2>order information</h2>
                    <p>first name: {{order.firstName}}</p>
                    <p>last name: {{order.lastName}}</p>
                    <p>address: {{order.address}}</p>
                    <p>city: {{order.city}}</p>
                   
                </div>
            </main>
        </div>

        <script type="text/javascript">
            let webstore = new Vue({
                el:'#app',
                data: {
                    sitename: 'huehue',
                    lessons: [],
                    cart:[],
                    showLesson:true,
                    showCart: false,
                    order:{
                        firstName:'',
                        lastName:'',
                        phoneNum: '',
                        address:'',
                        city:''
                    },
                    states: {
                        AL: 'Alabama',
                        AR: 'Arizona',
                        CA: 'California',
                        NV: 'Nevada'
                    }
                },
                methods:{
                    addToCart(lesson){
                        const shopCartButton = document.getElementById('shopCartButton');
                        shopCartButton.hidden = false;
                        this.cart.push(lesson);
                    },
                    removeCart(lesson){
                        let index = this.cart.indexOf(lesson);
                        if (index > -1) {
                            this.cart.splice(index, 1);
                        }
                    },
                    showShopCart(){
                        this.showLesson = this.showLesson ? false:true;
                        this.showCart = this.showCart ? false:true;
                    },
                    showOrder(){
                        this.showCart = this.showCart ? false:true;
                        const shopCartButton = document.getElementById('shopCartButton');
                        shopCartButton.hidden = true;
                    },
                    enableOrder() {
                        const regexName = /^[A-Za-z]+$/;
                        const regexNum = /^\d+$/;
                        return regexName.test(this.order.firstName) && regexNum.test(this.order.phoneNum);
                    },
                    submitForm(){
                        alert("order submitted !!");
                        this.showCart = this.showCart ? false:true;

                        let orderedLessons = webstore.cart.map(item => item.subject);
                        let orderedIDs = webstore.cart.map(item => item._id);

                        let itemCount = {};
                        for (let item of orderedLessons) {
                            itemCount[item] = (itemCount[item] || 0) + 1;
                        }

                        let lessonCount = [];
                        let lessonIds = [];

                        for (const item in itemCount) {
                            lessonCount.push(`${item} x ${itemCount[item]}`);
                            lessonIds.push(`${item} x ${itemCount[item]}`);
                        }

                        const newOrder = {name: this.order.firstName, phoneNum: this.order.phoneNum,
                            lessonIDs: lessonCount, numOfSpaces: orderedLessons.length};

                        fetch('https://cst3144-backend-1-ckst.onrender.com/collection/Orders', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(newOrder),
                        })
                        .then(response => response.json())
                        .then(responseJSON => {
                            document.getElementById('response').innerText = JSON.stringify(responseJSON);
                        })
                        .catch((error) => {
                            document.getElementById('error').innerText = error;
                        });

                        for (let i = 0; i < orderedIDs.length; i++) {
                            const lessonId = orderedIDs[i];
                            fetch(`https://cst3144-backend-1-ckst.onrender.com/collection/Lessons/${lessonId}/`)
                                .then(response => response.json())
                                .then(lessonData => {
                                const currentAvailability = lessonData.availability;
                                const newAvailability = currentAvailability - 1;

                                fetch(`https://cst3144-backend-1-ckst.onrender.com/collection/Lessons/${lessonId}/`, {
                                    method: 'PUT',
                                    headers: {
                                    'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ availability: newAvailability }),
                                })
                                .then(response => response.json())
                                .then(responseJSON => {
                                    document.getElementById('response').innerText = JSON.stringify(responseJSON);
                                })
                                .catch((error) => {
                                    document.getElementById('error').innerText = error;
                                });
                                })
                            .catch((error) => {
                            document.getElementById('error').innerText = error;
                            });
                        }
                    },
                    searchLessons(){
                        let userSearch = document.querySelector("#searchArea").value.toLowerCase();

                        fetch(`https://cst3144-backend-1-ckst.onrender.com/search/Lessons?search=${userSearch}`, {
                            method: 'GET'
                        })
                        .then(response => response.json())
                        .then(responseJSON => {
                            this.lessons = responseJSON;
                        })
                        .catch((error) => {
                            document.getElementById('error').innerText = error;
                        });
                    },
                    canAddToCart(lesson){
                        return lesson.availability>this.cartCount(lesson);
                    },
                    cartCount(lesson){
                        let count = 0;
                        for (let i = 0; i < this.cart.length; i++){
                            if (this.cart[i] === lesson){
                                count++;
                            }
                        }
                        return count;
                    },
                    sortLessons() {
                        let category = document.querySelector('input[name="sortCategory"]:checked').value;
                        let sortOrder = document.querySelector('input[name="sortOrder"]:checked').value;

                        if (sortOrder === "ascending"){
                            this.lessons.sort((a, b) => {
                                let valA = a[category];
                                let valB = b[category];

                                if (typeof valA === 'string' && typeof valB === 'string') {
                                    valA = valA.toLowerCase();
                                    valB = valB.toLowerCase();
                                }

                                if (valA > valB) return 1;
                                if (valB > valA) return -1;
                                return 0;
                            });
                        }
                        else{
                            this.lessons.sort((a, b) => {
                                let valA = b[category];
                                let valB = a[category];

                                if (typeof valA === 'string' && typeof valB === 'string') {
                                    valA = valA.toLowerCase();
                                    valB = valB.toLowerCase();
                                }

                                if (valA > valB) return 1;
                                if (valB > valA) return -1;
                                return 0;
                            });
                        }                        
                    }
                },
                computed:{
                    cartItemCount: function() { 
                        return this.cart.length || "";
                    },
                    canAddToCart: function(){
                        return this.lesson.availability > this.cartItemCount;
                    },
                    itemsLeft() {
                        return this.lesson.availability - this.cartItemCount;
                    },
                    cartNotEmpty() {
                        return cartCount != 0;
                    }
                }
            });
            fetch('https://cst3144-backend-1-ckst.onrender.com/collection/Lessons', {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                webstore.lessons = data.map(item => {
                    return {
                        _id: item._id,
                        id: item.id,
                        subject: item.subject,
                        location: item.location,
                        price: item.price,
                        image: item.image,
                        availability: item.availability,
                        rating: item.rating
                    };
                });
                webstore.lessons = webstore.lessons;
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            }); 
        </script>
    </body>
</html>